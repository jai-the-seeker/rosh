(window.webpackJsonp=window.webpackJsonp||[]).push([[28],{126:function(e,n,a){"use strict";a.r(n),a.d(n,"frontMatter",(function(){return o})),a.d(n,"metadata",(function(){return p})),a.d(n,"rightToc",(function(){return i})),a.d(n,"default",(function(){return d}));var t=a(2),r=a(6),c=(a(0),a(143)),o={title:"Spinning up Docker Infrastructure for Apache-Php-MySql",author:"Jai",tags:["docker","infrastructure"]},p={permalink:"/rosh/blog/2020/06/26/docker",source:"@site/blog\\2020-06-26-docker.md",description:"Spinning up docker infrastructure for apache-php-mysql can have its own queer requirements. In this blog we will see, how we can get going and setting it up.",date:"2020-06-26T00:00:00.000Z",tags:[{label:"docker",permalink:"/rosh/blog/tags/docker"},{label:"infrastructure",permalink:"/rosh/blog/tags/infrastructure"}],title:"Spinning up Docker Infrastructure for Apache-Php-MySql",readingTime:2.73,truncated:!0},i=[{value:"Installation",id:"installation",children:[]},{value:"What we Got!!!",id:"what-we-got",children:[]},{value:"<code>Dockerfile</code> for php-apache",id:"dockerfile-for-php-apache",children:[]},{value:"Compose <code>docker-compose.yml</code>",id:"compose-docker-composeyml",children:[]},{value:"<code>docker-compose up</code>",id:"docker-compose-up",children:[]},{value:"Testing our Docker Infrastructure",id:"testing-our-docker-infrastructure",children:[{value:"Test apache-php",id:"test-apache-php",children:[]},{value:"Test connection with database",id:"test-connection-with-database",children:[]}]},{value:"Peep inside my running php-apache instance",id:"peep-inside-my-running-php-apache-instance",children:[]}],l={rightToc:i};function d(e){var n=e.components,a=Object(r.a)(e,["components"]);return Object(c.a)("wrapper",Object(t.a)({},l,a,{components:n,mdxType:"MDXLayout"}),Object(c.a)("p",null,"Spinning up docker infrastructure for apache-php-mysql can have its own queer requirements. In this blog we will see, how we can get going and setting it up."),Object(c.a)("h2",{id:"installation"},"Installation"),Object(c.a)("p",null,"Let's download and install the ",Object(c.a)("inlineCode",{parentName:"p"},"CE-edition")," of docker and ",Object(c.a)("inlineCode",{parentName:"p"},"docker-compose")," from the official docker website."),Object(c.a)("h2",{id:"what-we-got"},"What we Got!!!"),Object(c.a)("p",null,"After fresh installation, we have"),Object(c.a)("pre",null,Object(c.a)("code",Object(t.a)({parentName:"pre"},{className:"language-bash"}),"$ docker image ls\nREPOSITORY          TAG                 IMAGE ID            CREATED             SIZE\nhello-world         latest              fce289e99eb9        15 months ago       1.84kB\n\n$ docker container ls\nCONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES\n\n$ docker network ls\nNETWORK ID          NAME                DRIVER              SCOPE\nefc1e1ca6409        bridge              bridge              local\n34f81bd2e623        host                host                local\n94d2f826785d        none                null                local\n")),Object(c.a)("h2",{id:"dockerfile-for-php-apache"},Object(c.a)("inlineCode",{parentName:"h2"},"Dockerfile")," for php-apache"),Object(c.a)("p",null,"Let us create a ",Object(c.a)("inlineCode",{parentName:"p"},"Dockerfile")," for installation of php-apache. This Dockerfile will cater for ",Object(c.a)("inlineCode",{parentName:"p"},"pdo_mysql")," extensions."),Object(c.a)("pre",null,Object(c.a)("code",Object(t.a)({parentName:"pre"},{}),"FROM php:7.4-apache\nRUN apt update && apt-get upgrade -y\nRUN docker-php-ext-install pdo_mysql\nEXPOSE 80\n")),Object(c.a)("h2",{id:"compose-docker-composeyml"},"Compose ",Object(c.a)("inlineCode",{parentName:"h2"},"docker-compose.yml")),Object(c.a)("p",null,"Now lets, create ",Object(c.a)("inlineCode",{parentName:"p"},"docker-compose.yml")," file. Create three folders in the directory containing ",Object(c.a)("inlineCode",{parentName:"p"},"docker-compose.yml")," file."),Object(c.a)("ul",null,Object(c.a)("li",{parentName:"ul"},Object(c.a)("inlineCode",{parentName:"li"},"php")),Object(c.a)("li",{parentName:"ul"},Object(c.a)("inlineCode",{parentName:"li"},"vol-db")),Object(c.a)("li",{parentName:"ul"},Object(c.a)("inlineCode",{parentName:"li"},"vol-php"))),Object(c.a)("p",null,"Copy the ",Object(c.a)("inlineCode",{parentName:"p"},"Dockerfile")," we created previously into the ",Object(c.a)("inlineCode",{parentName:"p"},"php")," folder. ",Object(c.a)("inlineCode",{parentName:"p"},"vol-db")," and ",Object(c.a)("inlineCode",{parentName:"p"},"vpl-php")," will be used to map the database and php volumes. We will also create a database and user for MySql, database ",Object(c.a)("inlineCode",{parentName:"p"},"myapp_db"),"; username ",Object(c.a)("inlineCode",{parentName:"p"},"devuser"),"; and password ",Object(c.a)("inlineCode",{parentName:"p"},"devpass"),"."),Object(c.a)("p",null,"So, our ",Object(c.a)("inlineCode",{parentName:"p"},"docker-compose.yml")," looks like:"),Object(c.a)("pre",null,Object(c.a)("code",Object(t.a)({parentName:"pre"},{className:"language-bash"}),"version: '3'\nservices:\n\n  db:\n    image: mysql:latest\n    container_name: app-db-mysql\n    environment:\n      MYSQL_ROOT_PASSWORD: tiger\n      MYSQL_DATABASE: myapp_db\n      MYSQL_USER: devuser\n      MYSQL_PASSWORD: devpass\n    volumes:\n      - ./vol-db:/var/lib/mysql/\n    networks:\n      - app-network\n\n  web:\n    build:    \n      context: ./php\n      dockerfile: Dockerfile\n    container_name: app-web-php74\n    depends_on:\n      - db\n    volumes:\n      - ./vol-php:/var/www/html/\n    ports:\n      - 5000:80\n    networks:\n      - app-network\n\n  phpmyadmin:\n    image: phpmyadmin/phpmyadmin\n    container_name: app-phpmyadmin\n    depends_on:\n      - db    \n    links: \n      - db:db    \n    environment:      \n      MYSQL_ROOT_PASSWORD: tiger \n    ports:\n      - 5001:80\n    networks:\n      - app-network\n\nnetworks:\n  app-network:\n\n")),Object(c.a)("h2",{id:"docker-compose-up"},Object(c.a)("inlineCode",{parentName:"h2"},"docker-compose up")),Object(c.a)("p",null,Object(c.a)("inlineCode",{parentName:"p"},"cd")," into the directory containing ",Object(c.a)("inlineCode",{parentName:"p"},"docker-compose.yml")," file and the run ",Object(c.a)("inlineCode",{parentName:"p"},"docker-compose up")," command. "),Object(c.a)("p",null,"Now, lets check the sate of our docker containers and networks"),Object(c.a)("pre",null,Object(c.a)("code",Object(t.a)({parentName:"pre"},{className:"language-bash"}),'$ docker container ls --format "{{.ID}}: {{.Names}}: {{.Ports}}"\n1f3cb046fe8c: app-web-php74: 0.0.0.0:5000->80/tcp\nc715238c051c: app-phpmyadmin: 0.0.0.0:5001->80/tcp\nb66a4f79e291: app-db-mysql: 3306/tcp, 33060/tcp\n\n$ docker network ls \nNETWORK ID          NAME                          DRIVER              SCOPE\n5e9b89160c36        app-machine_app-network       bridge              local\nefc1e1ca6409        bridge                        bridge              local\na2e9779a2337        docker-files_server-network   bridge              local\n34f81bd2e623        host                          host                local\n94d2f826785d        none                          null                local\n')),Object(c.a)("pre",null,Object(c.a)("code",Object(t.a)({parentName:"pre"},{className:"language-bash"}),'$ docker network inspect app-machine_app-network \n...\n        "Containers": {\n            "1f3cb046fe8cd8a1c6581d8c582d1acc6854b6af5badf17f6ed395a4f4acd934": {\n                "Name": "app-web-php74",\n                "EndpointID": "4807260f315b9b97cec457e73c5eec78ad70170d0e7b4e34fd30c57448b96e8f",\n                "MacAddress": "02:42:ac:19:00:04",\n                "IPv4Address": "172.25.0.4/16",\n                "IPv6Address": ""\n            },\n            "b66a4f79e2911a56671a2c35543ac2d9bb2a4ef8826f2f426ba6a555ace46ff6": {\n                "Name": "app-db-mysql",\n                "EndpointID": "eff9246fa1ffd075ca5b7a66f2ab5a01177b7607a50b545a9814eda76b1e22e6",\n                "MacAddress": "02:42:ac:19:00:02",\n                "IPv4Address": "172.25.0.2/16",\n                "IPv6Address": ""\n            },\n            "c715238c051c85f3516d55e70079b3fe85bad7a43c6bc9cc64601b81f9650f62": {\n                "Name": "app-phpmyadmin",\n                "EndpointID": "3626814d31c4909c05a41f73bb7afb06fded070d217c9ece38cf297e31626850",\n                "MacAddress": "02:42:ac:19:00:03",\n                "IPv4Address": "172.25.0.3/16",\n                "IPv6Address": ""\n            }\n        },\n...\n')),Object(c.a)("h2",{id:"testing-our-docker-infrastructure"},"Testing our Docker Infrastructure"),Object(c.a)("h3",{id:"test-apache-php"},"Test apache-php"),Object(c.a)("p",null,"Let's create ",Object(c.a)("inlineCode",{parentName:"p"},"index.php")," file and place it in ",Object(c.a)("inlineCode",{parentName:"p"},"vol-php")," folder"),Object(c.a)("pre",null,Object(c.a)("code",Object(t.a)({parentName:"pre"},{className:"language-php"}),"<?php\n// Show all information, defaults to INFO_ALL\nphpinfo();\n?>\n")),Object(c.a)("p",null,"In the browser, write ",Object(c.a)("inlineCode",{parentName:"p"},"localhost:5000")," and we should get ",Object(c.a)("inlineCode",{parentName:"p"},"phpinfo")," page. Similarly, we can check ",Object(c.a)("inlineCode",{parentName:"p"},"phpmyadmin")," page by checking url ",Object(c.a)("inlineCode",{parentName:"p"},"localhost:5001"),"."),Object(c.a)("h3",{id:"test-connection-with-database"},"Test connection with database"),Object(c.a)("p",null,"create a file ",Object(c.a)("inlineCode",{parentName:"p"},"conn.php")," in ",Object(c.a)("inlineCode",{parentName:"p"},"vol-php")," folder"),Object(c.a)("pre",null,Object(c.a)("code",Object(t.a)({parentName:"pre"},{className:"language-php"}),'<?php\n$servername = "app-db-mysql";\n$username   = "devuser";\n$password   = "devpass";\n\ntry {\n    $conn = new PDO("mysql:host=$servername;dbname=myapp_db", $username, $password);\n    // set the PDO error mode to exception\n    $conn->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);\n    echo "Connected successfully";\n    }\ncatch(PDOException $e)\n    {\n    echo "Connection failed: " . $e->getMessage();\n    }\n?>\n')),Object(c.a)("p",null,"Now, lets check the connection with database by running ",Object(c.a)("inlineCode",{parentName:"p"},"localhost:5000\\conn.php")),Object(c.a)("h2",{id:"peep-inside-my-running-php-apache-instance"},"Peep inside my running php-apache instance"),Object(c.a)("p",null,"Let's see whats happening inside my running docker instance"),Object(c.a)("pre",null,Object(c.a)("code",Object(t.a)({parentName:"pre"},{}),"$ docker exec -it app-web-php74 bash\n")))}d.isMDXComponent=!0},143:function(e,n,a){"use strict";a.d(n,"a",(function(){return m}));var t=a(0),r=a.n(t);function c(e,n,a){return n in e?Object.defineProperty(e,n,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[n]=a,e}function o(e,n){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var t=Object.getOwnPropertySymbols(e);n&&(t=t.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),a.push.apply(a,t)}return a}function p(e){for(var n=1;n<arguments.length;n++){var a=null!=arguments[n]?arguments[n]:{};n%2?o(Object(a),!0).forEach((function(n){c(e,n,a[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):o(Object(a)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(a,n))}))}return e}function i(e,n){if(null==e)return{};var a,t,r=function(e,n){if(null==e)return{};var a,t,r={},c=Object.keys(e);for(t=0;t<c.length;t++)a=c[t],n.indexOf(a)>=0||(r[a]=e[a]);return r}(e,n);if(Object.getOwnPropertySymbols){var c=Object.getOwnPropertySymbols(e);for(t=0;t<c.length;t++)a=c[t],n.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(r[a]=e[a])}return r}var l=r.a.createContext({}),d=function(e){var n=r.a.useContext(l),a=n;return e&&(a="function"==typeof e?e(n):p(p({},n),e)),a},s={inlineCode:"code",wrapper:function(e){var n=e.children;return r.a.createElement(r.a.Fragment,{},n)}},b=r.a.forwardRef((function(e,n){var a=e.components,t=e.mdxType,c=e.originalType,o=e.parentName,l=i(e,["components","mdxType","originalType","parentName"]),b=d(a),m=t,u=b["".concat(o,".").concat(m)]||b[m]||s[m]||c;return a?r.a.createElement(u,p(p({ref:n},l),{},{components:a})):r.a.createElement(u,p({ref:n},l))}));function m(e,n){var a=arguments,t=n&&n.mdxType;if("string"==typeof e||t){var c=a.length,o=new Array(c);o[0]=b;var p={};for(var i in n)hasOwnProperty.call(n,i)&&(p[i]=n[i]);p.originalType=e,p.mdxType="string"==typeof e?e:t,o[1]=p;for(var l=2;l<c;l++)o[l]=a[l];return r.a.createElement.apply(null,o)}return r.a.createElement.apply(null,a)}b.displayName="MDXCreateElement"}}]);